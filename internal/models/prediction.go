package models

import (
	"time"
)

// Prediction represents an energy price prediction generated by the ML model.
// Each prediction is linked to a household's smart meter and optionally logged
// to the blockchain for immutable verification.
type Prediction struct {
	ID                  uint      `json:"id" gorm:"primaryKey;autoIncrement"`
	UserID              uint      `json:"userId" gorm:"index;not null"`
	HouseID             string    `json:"houseId" gorm:"column:house_id;index;not null;size:50"`
	MeterID             string    `json:"meterId" gorm:"column:meter_id;index;not null;size:50"`
	Timestamp           time.Time `json:"timestamp" gorm:"index;not null"`
	Hour                int       `json:"hour" gorm:"not null"`        // 0-23
	Temperature         float64   `json:"temperature" gorm:"not null"` // Celsius
	ConsumptionKwh      float64   `json:"consumptionKwh" gorm:"column:consumption_kwh;not null"`
	PredictedPrice      float64   `json:"predictedPrice" gorm:"column:predicted_price;not null"` // â‚¬/kWh
	Confidence          int       `json:"confidence" gorm:"not null"`                            // 0-100%
	BlockchainTx        string    `json:"blockchainTx" gorm:"column:blockchain_tx;index;size:100"`
	BlockchainConfirmed bool      `json:"blockchainConfirmed" gorm:"column:blockchain_confirmed;default:false"`
	CreatedAt           time.Time `json:"createdAt" gorm:"autoCreateTime"`

	// Relations
	User      User      `json:"-" gorm:"foreignKey:UserID"`
	Household Household `json:"-" gorm:"foreignKey:HouseID"`
}

func (Prediction) TableName() string {
	return "predictions"
}

// BlockchainLog stores the details of blockchain transactions for predictions.
// This provides an audit trail and verification mechanism.
type BlockchainLog struct {
	ID              uint       `json:"id" gorm:"primaryKey;autoIncrement"`
	PredictionID    uint       `json:"predictionId" gorm:"index;not null"`
	TransactionHash string     `json:"transactionHash" gorm:"column:transaction_hash;uniqueIndex;not null;size:100"`
	BlockNumber     uint64     `json:"blockNumber" gorm:"column:block_number"`
	GasUsed         uint64     `json:"gasUsed" gorm:"column:gas_used"`
	Status          string     `json:"status" gorm:"size:20"` // pending, confirmed, failed
	ContractAddress string     `json:"contractAddress" gorm:"column:contract_address;size:100"`
	LoggedAt        time.Time  `json:"loggedAt" gorm:"column:logged_at;autoCreateTime"`
	ConfirmedAt     *time.Time `json:"confirmedAt" gorm:"column:confirmed_at"`

	// Relation
	Prediction Prediction `json:"-" gorm:"foreignKey:PredictionID"`
}

func (BlockchainLog) TableName() string {
	return "blockchain_log"
}

// ========== Request/Response DTOs ==========

// PredictionInput is the data received from MQTT smart meters
type PredictionInput struct {
	MeterID        string  `json:"meterId"`
	Timestamp      string  `json:"timestamp"`
	Temperature    float64 `json:"temperature"`
	ConsumptionKwh float64 `json:"consumptionKwh"`
}

// PredictionOutput is the response with the predicted price
type PredictionOutput struct {
	MeterID        string  `json:"meterId"`
	Timestamp      string  `json:"timestamp"`
	PredictedPrice float64 `json:"predictedPrice"`
	Confidence     int     `json:"confidence"`
	BlockchainTx   string  `json:"blockchainTx,omitempty"`
}

// PredictionResponse is the full API response for a prediction
type PredictionResponse struct {
	ID                  uint    `json:"id"`
	UserID              uint    `json:"userId"`
	HouseID             string  `json:"houseId"`
	MeterID             string  `json:"meterId"`
	Timestamp           string  `json:"timestamp"`
	Hour                int     `json:"hour"`
	Temperature         float64 `json:"temperature"`
	ConsumptionKwh      float64 `json:"consumptionKwh"`
	PredictedPrice      float64 `json:"predictedPrice"`
	Confidence          int     `json:"confidence"`
	BlockchainTx        string  `json:"blockchainTx"`
	BlockchainConfirmed bool    `json:"blockchainConfirmed"`
}

// ToResponse converts Prediction to PredictionResponse
func (p *Prediction) ToResponse() PredictionResponse {
	return PredictionResponse{
		ID:                  p.ID,
		UserID:              p.UserID,
		HouseID:             p.HouseID,
		MeterID:             p.MeterID,
		Timestamp:           p.Timestamp.Format(time.RFC3339),
		Hour:                p.Hour,
		Temperature:         p.Temperature,
		ConsumptionKwh:      p.ConsumptionKwh,
		PredictedPrice:      p.PredictedPrice,
		Confidence:          p.Confidence,
		BlockchainTx:        p.BlockchainTx,
		BlockchainConfirmed: p.BlockchainConfirmed,
	}
}

// PredictionQuery contains filters for querying predictions
type PredictionQuery struct {
	HouseID   string `form:"houseId"`
	MeterID   string `form:"meterId"`
	StartDate string `form:"startDate"`
	EndDate   string `form:"endDate"`
	Page      int    `form:"page,default=1"`
	Limit     int    `form:"limit,default=20"`
}

// StatisticsResponse provides aggregated statistics
type StatisticsResponse struct {
	TotalPredictions    int64   `json:"totalPredictions"`
	TotalHouseholds     int64   `json:"totalHouseholds"`
	AveragePrice        float64 `json:"averagePrice"`
	AverageConsumption  float64 `json:"averageConsumption"`
	BlockchainConfirmed int64   `json:"blockchainConfirmed"`
	LastPredictionAt    string  `json:"lastPredictionAt"`
}

// AdminDashboardResponse contains system-wide statistics for admins
type AdminDashboardResponse struct {
	TotalUsers          int64                `json:"totalUsers"`
	TotalHouseholds     int64                `json:"totalHouseholds"`
	TotalPredictions    int64                `json:"totalPredictions"`
	ActiveSessions      int64                `json:"activeSessions"`
	BlockchainConfirmed int64                `json:"blockchainConfirmed"`
	RecentPredictions   []PredictionResponse `json:"recentPredictions"`
	SystemHealth        string               `json:"systemHealth"`
}
